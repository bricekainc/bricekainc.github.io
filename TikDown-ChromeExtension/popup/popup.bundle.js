(()=>{var e,t,n;function r(e,t,n,r,o,a,s){try{var i=e[a](s),l=i.value}catch(e){return void n(e)}i.done?t(l):Promise.resolve(l).then(r,o)}function o(e){return function(){var t=this,n=arguments;return new Promise(function(o,a){var s=e.apply(t,n);function i(e){r(s,o,a,i,l,"next",e)}function l(e){r(s,o,a,i,l,"throw",e)}i(void 0)})}}t=localStorage.getItem("tik.tok::themeMode")||"system",n=t,"system"===t&&(n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),"dark"===n?(document.body.classList.add("theme-dark"),document.documentElement.classList.add("theme-dark")):(document.body.classList.remove("theme-dark"),document.documentElement.classList.remove("theme-dark"));var a="tik.tok::extensionEnabled";function s(){return i.apply(this,arguments)}function i(){return(i=o(function*(){var e;try{var t;if("undefined"!=typeof chrome&&null!==(t=chrome.runtime)&&void 0!==t&&t.sendMessage){var n=yield new Promise(e=>{chrome.runtime.sendMessage({action:"getState"},t=>{var n;if(null!==(n=chrome.runtime)&&void 0!==n&&n.lastError)return e(null);e(t)})});if(n&&void 0!==n.enabled){try{localStorage.setItem(a,n.enabled?"true":"false")}catch(e){}return!!n.enabled}}}catch(e){}try{var r=localStorage.getItem(a);return null===r||!("false"===(e=r)||!1===e)}catch(e){return!0}})).apply(this,arguments)}function l(){return(l=o(function*(e){var t=e?"true":"false",n=!1;try{var r;if("undefined"!=typeof chrome&&null!==(r=chrome.runtime)&&void 0!==r&&r.sendMessage){var o=yield new Promise((t,n)=>{chrome.runtime.sendMessage({action:"toggleState",enabled:!!e},e=>{var r;if(null!==(r=chrome.runtime)&&void 0!==r&&r.lastError)return n(chrome.runtime.lastError);t(e)})});!1===(null==o?void 0:o.success)||(n=!0)}}catch(e){}if(n)try{localStorage.setItem(a,t)}catch(e){}})).apply(this,arguments)}function c(){return c=o(function*(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:150,r=0;r<t;r++){if((yield s())===e)return yield new Promise(e=>setTimeout(e,50)),!0;r<t-1&&(yield new Promise(e=>setTimeout(e,n)))}return!1}),c.apply(this,arguments)}o(function*(){var e;function t(){return n.apply(this,arguments)}function n(){return n=o(function*(){var e=yield s(),t=document.getElementById("disabled-state"),n=document.getElementById("normal-state"),r=document.getElementById("turnOnBtn");if(e?(t&&(t.style.display="none"),n&&(n.style.display="block")):(t&&(t.style.display="block"),n&&(n.style.display="none")),r&&!e){var a=r.cloneNode(!0);r.parentNode.replaceChild(a,r),a.addEventListener("click",o(function*(){var e=document.getElementById("disabled-state"),t=document.getElementById("normal-state");a.disabled=!0;var n=a.textContent;a.textContent="Turning on...";try{var r=null;"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage&&(r=new Promise(e=>{var t=n=>{if("stateBroadcast"===(null==n?void 0:n.action)&&!0===n.enabled){try{chrome.runtime.onMessage.removeListener(t)}catch(e){}e(!0)}};try{chrome.runtime.onMessage.addListener(t)}catch(t){return void e(!1)}setTimeout(()=>{try{chrome.runtime.onMessage.removeListener(t)}catch(e){}e(!1)},3e3)})),yield function(e){return l.apply(this,arguments)}(!0);var s=function(e){return c.apply(this,arguments)}(!0,15,100),i=!1,d=!1;if(r){var u=yield Promise.race([r.then(e=>({source:"broadcast",ok:e})),s.then(e=>({source:"poll",ok:e}))]);"broadcast"===u.source?(i=u.ok,u.ok||(d=yield s)):(d=u.ok,u.ok||(i=yield r))}else d=yield s;if(i||d)e&&(e.style.display="none"),t&&(t.style.display="block"),setTimeout(o(function*(){"function"==typeof window.checkAndUpdateUI&&(yield window.checkAndUpdateUI())}),200);else{a.disabled=!1,a.textContent=n;var m=document.createElement("p");m.textContent="Failed to enable extension. Please try again.",m.style.cssText="margin-top: 15px; color: #ef4444; font-weight: bold;",e&&(e.querySelectorAll("p").forEach(t=>{t!==e.querySelector(".footnote")&&t.remove()}),e.appendChild(m))}}catch(t){a.disabled=!1,a.textContent=n;var p=document.createElement("p");p.textContent="Error enabling extension. Please try again.",p.style.cssText="margin-top: 15px; color: #ef4444; font-weight: bold;",e&&(e.querySelectorAll("p").forEach(t=>{t!==e.querySelector(".footnote")&&t.remove()}),e.appendChild(p))}}))}}),n.apply(this,arguments)}window.checkAndUpdateUI=t,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t(),window.addEventListener("focus",()=>{t()}),document.addEventListener("visibilitychange",()=>{document.hidden||t()}),"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.addListener((e,n)=>{"local"===n&&e[a]&&t()}),"undefined"!=typeof chrome&&null!==(e=chrome.runtime)&&void 0!==e&&e.onMessage&&chrome.runtime.onMessage.addListener(e=>{"stateBroadcast"===(null==e?void 0:e.action)&&t()})})(),null===(e=document.getElementById("startBtn"))||void 0===e||e.addEventListener("click",e=>{e.preventDefault();var t=document.getElementById("username").value.trim(),n="https://tiktok.com/";t.startsWith("@")&&(t=t.slice(1)),t.startsWith("https://tiktok.com")||t.startsWith("https://www.tiktok.com")?window.open(t):t.startsWith("tiktok.com")||t.startsWith("www.tiktok.com")?window.open("https://"+t):t?window.open("".concat(n,"@").concat(t),"_blank"):window.open(n,"_blank")}),o(function*(){var e,t,n,r,a,s={getAllProgress:(a=o(function*(){try{return new Promise(e=>{chrome.runtime.sendMessage({action:"getProgress"},t=>{if(chrome.runtime.lastError)e({});else{var n=(null==t?void 0:t.progress)||{};e(n)}})})}catch(e){return{}}}),function(){return a.apply(this,arguments)}),clearUser:(r=o(function*(e){try{var t=yield s.getAllProgress(),n=e.toLowerCase().trim();if(t[n])return delete t[n],new Promise(e=>{chrome.runtime.sendMessage({action:"setProgress",progress:t},t=>{chrome.runtime.lastError,e()})})}catch(e){}}),function(e){return r.apply(this,arguments)}),clearTab:(n=o(function*(e,t){try{var n,r=yield s.getAllProgress(),o=e.toLowerCase().trim();if(null!==(n=r[o])&&void 0!==n&&n[t])return delete r[o][t],new Promise(e=>{chrome.runtime.sendMessage({action:"setProgress",progress:r},t=>{chrome.runtime.lastError,e()})})}catch(e){}}),function(e,t){return n.apply(this,arguments)}),clearAllProgress:(t=o(function*(){try{return new Promise(e=>{chrome.runtime.sendMessage({action:"clearProgress"},t=>{chrome.runtime.lastError,e()})})}catch(e){}}),function(){return t.apply(this,arguments)}),getProgress:(e=o(function*(e,t){try{var n;return(null===(n=(yield s.getAllProgress())[e.toLowerCase().trim()])||void 0===n?void 0:n[t])||[]}catch(e){return[]}}),function(t,n){return e.apply(this,arguments)})},i=document.getElementById("pastDownloadsBtn"),l=document.getElementById("pastDownloadsModal"),c=document.getElementById("closePastDownloadsBtn"),d=document.getElementById("pastDownloadsContent");if(i&&l&&c&&d){i.addEventListener("click",function(){l.style.display="flex",h()}),c.addEventListener("click",m),l.addEventListener("click",e=>{e.target===l&&m()});var u={videos:"Videos",reposts:"Reposts",liked:"Liked",favorites:"Favorites"}}function m(){l.style.display="none"}function p(e){return u[e]||e.charAt(0).toUpperCase()+e.slice(1)}function h(){return v.apply(this,arguments)}function v(){return v=o(function*(){try{d.innerHTML='<p style="text-align: center; color: #666; padding: 20px;">Loading...</p>';var e=yield s.getAllProgress(),t=Object.keys(e).sort();if(0===t.length)return void(d.innerHTML='\n          <div style="text-align: center; padding: 40px 20px; color: #666;">\n            <p style="font-size: 16px; margin-bottom: 10px;">No downloads yet</p>\n            <p style="font-size: 13px;">Start downloading videos to see them here!</p>\n          </div>\n        ');var n='<div class="past-downloads-scroll">';t.forEach(t=>{var r=e[t],o=Object.keys(r).filter(e=>"_metadata"!==e).sort();n+='\n          <div class="past-downloads-user">\n            <div class="past-downloads-user-head">\n              <div class="past-downloads-username">@'.concat(t,'</div>\n              <button class="clear-user-btn ghost" data-username="').concat(t,'">\n                üóëÔ∏è Clear All\n              </button>\n            </div>\n            <div class="past-downloads-tabs">\n        '),o.forEach(e=>{var o=r[e]||[],a=Array.isArray(o)?o.length:0;n+='\n            <div class="past-downloads-tab">\n              <div class="past-downloads-tab-meta">\n                <span class="past-downloads-tab-label">'.concat(p(e),'</span>\n                <span class="past-downloads-tab-count">').concat(a,' items</span>\n              </div>\n              <div class="past-downloads-tab-actions">\n                <button class="download-csv-btn ghost" data-username="').concat(t,'" data-tab="').concat(e,'" title="Download CSV">\n                  üì• CSV\n                </button>\n                <button class="resume-download-btn ghost" data-username="').concat(t,'" data-tab="').concat(e,'" title="Resume Download">\n                  ‚ñ∂Ô∏è Resume\n                </button>\n                <button class="clear-tab-btn ghost" data-username="').concat(t,'" data-tab="').concat(e,'">\n                  Clear\n                </button>\n              </div>\n            </div>\n          ')}),n+="\n            </div>\n          </div>\n        "}),n+="</div>",n+='\n        <div class="past-downloads-footer">\n          <button id="clearAllBtn" class="btn danger">\n            üóëÔ∏è Clear All Downloads\n          </button>\n        </div>\n      ',d.innerHTML=n,document.querySelectorAll(".clear-user-btn").forEach(e=>{e.addEventListener("click",function(){var e=o(function*(e){var t=e.target.dataset.username;confirm("Clear all downloads for @".concat(t,"?"))&&(yield s.clearUser(t),h())});return function(t){return e.apply(this,arguments)}}())}),document.querySelectorAll(".download-csv-btn").forEach(e=>{e.addEventListener("click",function(){var e=o(function*(e){var t=e.target.dataset.username,n=e.target.dataset.tab;try{var r=yield s.getProgress(t,n);if(!r||0===r.length)return void alert("No items to export");var o=r.map((e,r)=>{var o=e,a="";if(e.includes(":")){var s=e.split(":");o=s[0],a=s[1]||""}return[r+1,o,a,t,n].map(e=>'"'.concat(String(e).replace(/"/g,'""'),'"')).join(",")}),a=[["index","videoId","imageIndex","username","tab"].join(","),...o].join("\n"),i=new Blob([a],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(i),c=t.replace(/[^a-zA-Z0-9_]/g,"_"),d=n.replace(/[^a-zA-Z0-9_]/g,"_"),u="downloads_".concat(c,"_").concat(d,"_").concat((new Date).toISOString().split("T")[0],".csv"),m=document.createElement("a");m.href=l,m.download=u,m.click(),URL.revokeObjectURL(l),setTimeout(()=>{window.close()},100)}catch(e){alert("Failed to export CSV: "+(e.message||"Unknown error"))}});return function(t){return e.apply(this,arguments)}}())}),document.querySelectorAll(".resume-download-btn").forEach(e=>{e.addEventListener("click",function(){var e=o(function*(e){var t=e.target.dataset.username,n=e.target.dataset.tab;try{var r=yield chrome.tabs.query({active:!0,currentWindow:!0});if(!r[0])return void alert("Please open a TikTok page first");var o,a=r[0].url,s="videos"!==n&&"liked"!==n&&"favorites"!==n&&"reposts"!==n,i=null;if(s)try{var l=yield new Promise(e=>{chrome.runtime.sendMessage({action:"getCollectionUrl",username:t,tabName:n},t=>{chrome.runtime.lastError?e(null):e((null==t?void 0:t.collectionUrl)||null)})});i=l}catch(e){}o=s&&i?"https://www.tiktok.com".concat(i):"https://www.tiktok.com/@".concat(t),a.includes(o.replace("https://www.tiktok.com",""))?chrome.tabs.sendMessage(r[0].id,{action:"resumeDownload",payload:{username:t,tabName:n,isCollection:s,collectionUrl:i}},e=>{chrome.runtime.lastError?alert("Failed to trigger download. Please refresh the page."):window.close()}):(yield chrome.tabs.update(r[0].id,{url:o}),setTimeout(()=>{chrome.tabs.sendMessage(r[0].id,{action:"resumeDownload",payload:{username:t,tabName:n,isCollection:s,collectionUrl:i}},e=>{chrome.runtime.lastError?alert("Failed to trigger download. Please make sure you're on the correct page."):window.close()})},3e3))}catch(e){alert("Failed to resume download. Please try again.")}});return function(t){return e.apply(this,arguments)}}())}),document.querySelectorAll(".clear-tab-btn").forEach(e=>{e.addEventListener("click",function(){var e=o(function*(e){var t=e.target.dataset.username,n=e.target.dataset.tab;confirm("Clear ".concat(p(n)," downloads for @").concat(t,"?"))&&(yield s.clearTab(t,n),h())});return function(t){return e.apply(this,arguments)}}())});var r=document.getElementById("clearAllBtn");r&&r.addEventListener("click",o(function*(){confirm("Clear ALL downloads history? This cannot be undone.")&&(yield s.clearAllProgress(),h())}))}catch(e){d.innerHTML='\n        <div style="text-align: center; padding: 20px; color: #ff3b30;">\n          <p>Error loading downloads history</p>\n        </div>\n      '}}),v.apply(this,arguments)}})()})();